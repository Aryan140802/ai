import os
import re
import logging
import pymysql
import traceback
from typing import List, Optional, Dict, Any
from datetime import datetime
import json

from langchain_community.utilities import SQLDatabase
from langchain_ollama import OllamaLLM
from langchain.chains import create_sql_query_chain

# --- FAR DETAILS CONFIGURATION ---

FAR_DB_CONFIG = {
    "name": "FAR Details",
    "db_config": {
        "host": "localhost", 
        "user": "root", 
        "password": "root123", 
        "database": "EIS_n"
    },
    "include_tables": ["FarDetailsAll"],
}

# Blocked patterns for security
BLOCKED_PATTERNS = [
    r"\brm\b", r"\bkill\b", r"\breboot\b", r"\bshutdown\b", r"\buserdel\b",
    r"\bpasswd\b", r"\bmkfs\b", r"\bwget\b", r"\bcurl\b", r":\s*(){:|:&};:",
    r"\bsudo\b", r"\bsu\b", r"\bchmod\b", r"\bchown\b", r"\bdd\b",
    r"\bmount\s+/", r"\bumount\b", r"\bfdisk\b", r"\bparted\b", r"\bmkfs\b",
    r"\biptables\b", r"\bufw\b", r"\bfirewall\b", r"\bselinux\b"
]

# Setup logging
logging.basicConfig(
    filename=os.path.expanduser("~/.far_details_ai.log"),
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

def is_dangerous(text: str) -> bool:
    """Check if text contains dangerous patterns"""
    return any(re.search(pattern, text.lower()) for pattern in BLOCKED_PATTERNS)

def clean_sql(raw_sql: str) -> str:
    """Clean and enhance SQL for LIKE operations"""
    # Extract SQL from code blocks
    match = re.search(r"```sql\s*(.*?)\s*```", raw_sql, re.DOTALL | re.IGNORECASE)
    if match:
        sql = match.group(1)
    else:
        sql = re.sub(r"```", "", raw_sql)
        sql = re.sub(r"^(.*?)(SELECT|INSERT|UPDATE|DELETE|WITH)", r"\2", sql, flags=re.IGNORECASE | re.DOTALL)
    
    # Replace = with LIKE for string comparisons
    sql = re.sub(r"(\w+)\s*=\s*'([^']*)'", r"\1 LIKE '%\2%'", sql, flags=re.IGNORECASE)
    sql = re.sub(r"(\w+)\s*=\s*\"([^\"]*)\"", r"\1 LIKE '%\2%'", sql, flags=re.IGNORECASE)
    
    return sql.strip().rstrip(";")

def format_answer(result: List[tuple], columns: Optional[List[str]] = None) -> str:
    """Format database results for display"""
    if not result:
        return "No FAR details found for your request."
    
    if len(result) == 1 and len(result[0]) == 1:
        return f"Result: {result[0][0]}"
    
    if columns and len(result) <= 10:
        output = []
        col_widths = [max(len(str(col)), max(len(str(row[i])) for row in result)) for i, col in enumerate(columns)]
        header = " | ".join(col.ljust(width) for col, width in zip(columns, col_widths))
        separator = "-+-".join("-" * width for width in col_widths)
        output.append(header)
        output.append(separator)
        for row in result[:10]:
            formatted_row = " | ".join(str(val).ljust(width) for val, width in zip(row, col_widths))
            output.append(formatted_row)
        if len(result) > 10:
            output.append(f"... and {len(result) - 10} more rows")
        return "\n".join(output)
    
    rows = []
    for row in result[:20]:
        rows.append(" | ".join(str(val) for val in row))
    if len(result) > 20:
        rows.append(f"... and {len(result) - 20} more rows")
    return "\n".join(rows)

def is_select_query(sql: str) -> bool:
    """Check if query is a safe SELECT query"""
    return sql.strip().lower().startswith('select')

class FarDetailsAssistant:
    def __init__(self):
        self.llm = None
        self.db_handler = None
        self.initialized = False
        self.chat_history = []

    def initialize(self):
        """Initialize the FAR Details Assistant"""
        try:
            print("ğŸ”§ Initializing FAR Details Assistant...")
            self.llm = OllamaLLM(model="myllm:latest", temperature=0.1)
            
            # Setup database connection
            db_cfg = FAR_DB_CONFIG['db_config']
            uri = f"mysql+pymysql://{db_cfg['user']}:{db_cfg['password']}@{db_cfg['host']}/{db_cfg['database']}"
            db_for_llm = SQLDatabase.from_uri(uri, include_tables=FAR_DB_CONFIG.get("include_tables"))
            
            # Create chain for SQL generation
            chain = create_sql_query_chain(self.llm, db_for_llm)
            db_conn = pymysql.connect(**db_cfg)
            
            self.db_handler = {
                'chain': chain,
                'connection': db_conn,
                'config': FAR_DB_CONFIG
            }
            
            print("âœ… FAR Details database connected")
            self.initialized = True
            print("ğŸ‰ FAR Details Assistant initialized successfully!")
            return True
            
        except Exception as e:
            print(f"âŒ Initialization failed: {e}")
            logger.error(f"Initialization failed: {e}", exc_info=True)
            return False

    def save_feedback(self, question, answer, feedback):
        """Save user feedback for continuous improvement"""
        data = {
            "question": question,
            "answer": answer,
            "feedback": feedback,
            "timestamp": datetime.now().isoformat(),
            "module": "far_details"
        }
        try:
            with open("far_feedback_log.jsonl", "a") as f:
                f.write(json.dumps(data) + "\n")
        except Exception as e:
            logger.error(f"Failed to save feedback: {e}")

    def find_relevant_feedback(self, question):
        """Find relevant feedback from previous interactions"""
        try:
            with open("far_feedback_log.jsonl", "r") as f:
                lines = f.readlines()
            for line in lines[::-1]:
                entry = json.loads(line)
                if entry["question"].strip().lower() in question.strip().lower():
                    return entry["feedback"]
        except Exception:
            pass
        return None

    def query_far_details(self, question: str) -> str:
        """Query FAR details database"""
        if not self.db_handler:
            return "âŒ FAR Details database not available."
        
        try:
            # Enhanced prompt for LIKE-based queries
            enhanced_question = f"""
            {question}
            
            Important: When searching for FAR details, processes, or any text fields, use LIKE with wildcards (%) instead of exact matches (=). 
            For example: 
            - Use "process_name LIKE '%web%'" instead of "process_name = 'web'"
            - Use "details LIKE '%error%'" instead of "details = 'error'"
            - Use "status LIKE '%active%'" instead of "status = 'active'"
            
            Focus on the FarDetailsAll table for process information.
            """

            raw_sql = self.db_handler['chain'].invoke({"question": enhanced_question})
            sql = clean_sql(raw_sql)
            print(f"ğŸ” Generated SQL: {sql}")

            if not is_select_query(sql):
                return "âš ï¸ Only SELECT queries are allowed for security."
            
            with self.db_handler['connection'].cursor() as cursor:
                cursor.execute(sql)
                result = cursor.fetchall()
                columns = [desc[0] for desc in cursor.description] if cursor.description else None
            
            if not result:
                return "ğŸ“­ No FAR details found matching your query. Try using broader search terms."
            
            formatted_result = format_answer(result, columns)
            
            # Build context for AI interpretation
            context = ""
            for turn in self.chat_history[-3:]:
                context += f"User: {turn['user']}\nAssistant: {turn['assistant']}\n"
            
            context += f"""User: {question}
Assistant:

FAR Details query results:
{formatted_result}

Please provide a clear, natural language response about these FAR details/processes. Make it conversational and helpful. If the results show partial matches due to LIKE queries, explain that these are similar/related entries. Focus on process-related information."""
            
            # Check for relevant feedback
            feedback = self.find_relevant_feedback(question)
            if feedback:
                context += f"\nNote: Previously, a user provided this correction for a similar question: '{feedback}'"
            
            ai_interpretation = self.llm.invoke(context)
            self.chat_history.append({"user": question, "assistant": ai_interpretation})
            return ai_interpretation
            
        except Exception as e:
            logger.error(f"FAR details query error: {e}")
            return f"âŒ Unable to retrieve FAR details: {e}"

    def process_question(self, question: str) -> str:
        """Process all questions as FAR-related queries"""
        if not self.initialized:
            return "âŒ FAR Details Assistant not initialized. Please restart."
        
        if is_dangerous(question):
            return "âš ï¸ Question blocked for security reasons."
        
        # All questions are processed as FAR details queries
        return self.query_far_details(question)

    def show_help(self):
        """Display help information"""
        help_text = """
ğŸ“‹ FAR DETAILS ASSISTANT HELP

ğŸ¯ PURPOSE:
  Query and analyze FAR (Fixed Asset Register) details and process information

ğŸ” EXAMPLE QUERIES:
  Process Information:
  - "Show all processes like 'backup'"
  - "Find processes containing 'web'"
  - "Search for FAR details similar to 'error'"
  - "List processes with status like 'active'"
  - "Count processes containing 'database'"
  - "Show processes sorted by memory usage"
  - "Find processes with highest CPU usage"
  
  FAR Details:
  - "Show FAR details for processes like 'maintenance'"
  - "Find FAR entries containing 'asset'"
  - "Search for details similar to 'depreciation'"
  - "List FAR records with amount greater than 1000"
  - "Show recent FAR entries"
  - "Count FAR details by category"

ğŸ”§ FEATURES:
  âœ… Flexible LIKE-based searches (automatic partial matching)
  âœ… Natural language to SQL conversion
  âœ… AI-powered result interpretation
  âœ… Security-enforced (read-only operations)
  âœ… Feedback learning system
  âœ… Chat history context
  âœ… All queries processed as FAR details queries

ğŸ›¡ï¸ SECURITY:
  - Only SELECT queries allowed
  - Dangerous commands blocked
  - Input sanitization
  - Audit logging

ğŸ’¡ TIPS:
  - Use partial terms for better matches
  - Ask about specific processes or FAR categories
  - Questions are automatically enhanced for LIKE searches
  - Feedback helps improve future responses

ğŸ“ COMMANDS:
  - 'help' - Show this help
  - 'status' - Show system status
  - 'clear' - Clear screen
  - 'exit' - Quit assistant
        """
        print(help_text)

    def show_status(self):
        """Show current status"""
        print("ğŸ“Š FAR DETAILS ASSISTANT STATUS")
        print(f"ğŸ•’ Time: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
        print(f"ğŸ¤– AI Model: {'âœ… Initialized' if self.initialized else 'âŒ Not Initialized'}")
        print(f"ğŸ—„ï¸ Database: {'âœ… Connected' if self.db_handler and self.db_handler['connection'].open else 'âŒ Disconnected'}")
        print(f"ğŸ’¬ Chat History: {len(self.chat_history)} exchanges")
        print(f"ğŸ›¡ï¸ Security Patterns: {len(BLOCKED_PATTERNS)} active")
        
        if self.db_handler:
            try:
                with self.db_handler['connection'].cursor() as cursor:
                    cursor.execute("SELECT COUNT(*) FROM FarDetailsAll")
                    count = cursor.fetchone()[0]
                    print(f"ğŸ“¦ FAR Records Available: {count}")
            except Exception as e:
                print(f"ğŸ“¦ FAR Records: Unable to count ({e})")

    def start_interactive_session(self):
        """Start interactive session"""
        if not self.initialize():
            return
        
        os.system("cls" if os.name == "nt" else "clear")
        print("ğŸ¯ FAR DETAILS ASSISTANT READY")
        print("Specialized for FAR details and process information queries!")
        print("Ask me anything about your FAR database...")
        print("Type 'help' for detailed usage, 'exit' to quit\n")
        
        while True:
            try:
                question = input("FARâ“ ").strip()
                if not question:
                    continue
                
                question_lower = question.lower()
                
                if question_lower in ['exit', 'quit', 'q']:
                    print("ğŸ‘‹ Goodbye!")
                    break
                elif question_lower == 'help':
                    self.show_help()
                    continue
                elif question_lower == 'clear':
                    os.system("cls" if os.name == "nt" else "clear")
                    continue
                elif question_lower == 'status':
                    self.show_status()
                    continue
                
                response = self.process_question(question)
                print(f"\n{response}\n")
                
                # Feedback system
                feedback = input("ğŸ’¬ Was this answer helpful? (yes/no/correction): ").strip()
                if feedback.lower() not in ['yes', 'y', '']:
                    if feedback.lower() in ['no', 'n']:
                        correction = input("ğŸ’¡ What would be a better answer? ")
                        self.save_feedback(question, response, correction)
                    else:
                        self.save_feedback(question, response, feedback)
                    print("ğŸ“ Thank you for the feedback!")
                    
            except KeyboardInterrupt:
                print("\nğŸ‘‹ Goodbye!")
                break
            except Exception as e:
                print(f"\nâŒ Error: {e}")
                logger.error(f"Session error: {e}", exc_info=True)
        
        # Clean up
        if self.db_handler and self.db_handler['connection'].open:
            self.db_handler['connection'].close()
        print("ğŸ”’ Connection closed.")

def main():
    assistant = FarDetailsAssistant()
    assistant.start_interactive_session()

if __name__ == "__main__":
    main()
